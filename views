-- Views -- 

-- View 1: Shows units expiring within 20 days
CREATE VIEW view_expiring_units AS
SELECT 
    bui.unit_id,
    bui.expiry_date,
    DATEDIFF(bui.expiry_date, CURDATE()) AS days_remaining,
    d.blood_type,
    d.first_name AS donor_first_name,
    d.last_name AS donor_last_name,
    bui.unit_status
FROM bloodunit_info bui
INNER JOIN donors d ON bui.donor_id = d.donor_id
WHERE bui.expiry_date <= DATE_ADD(CURDATE(), INTERVAL 20 DAY)
  AND bui.expiry_date >= CURDATE()
  AND bui.unit_status = 'Available'
ORDER BY bui.expiry_date ASC;

-- View 2: Shows donors who are eligible to donate (60+ days since last donation)
CREATE VIEW view_eligible_donors AS
SELECT 
    donor_id,
    first_name,
    last_name,
    blood_type,
    phone_num,
    last_donated_date,
    CASE 
        WHEN last_donated_date IS NULL THEN 'Never Donated'
        ELSE CONCAT(DATEDIFF(CURDATE(), last_donated_date), ' days ago')
    END AS last_donation_info,
    CASE 
        WHEN last_donated_date IS NULL THEN 999
        ELSE DATEDIFF(CURDATE(), last_donated_date)
    END AS days_since_donation
FROM donors
WHERE last_donated_date <= DATE_SUB(CURDATE(), INTERVAL 60 DAY)
   OR last_donated_date IS NULL;
   
-- View 3: Shows available units count by blood type
CREATE VIEW view_inventory_summary AS
SELECT 
    d.blood_type,
    COUNT(bui.unit_id) AS available_units,
    MIN(bui.expiry_date) AS earliest_expiry,
    MAX(bui.expiry_date) AS latest_expiry,
    CASE 
        WHEN COUNT(bui.unit_id) < 5 THEN 'Low'
        WHEN COUNT(bui.unit_id) < 10 THEN 'On baseline'
        ELSE 'Surplus'
    END AS stock_status
FROM donors d
LEFT JOIN bloodunit_info bui ON d.donor_id = bui.donor_id 
    AND bui.unit_status = 'Available'
GROUP BY d.blood_type;


